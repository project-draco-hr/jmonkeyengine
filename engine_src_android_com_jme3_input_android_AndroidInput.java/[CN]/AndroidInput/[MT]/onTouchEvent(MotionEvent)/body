{
  boolean bWasHandled=false;
  TouchEvent touch;
  final int historySize=event.getHistorySize();
  final int pointerCount=event.getPointerCount();
switch (event.getAction()) {
case MotionEvent.ACTION_POINTER_1_DOWN:
case MotionEvent.ACTION_POINTER_2_DOWN:
case MotionEvent.ACTION_POINTER_3_DOWN:
case MotionEvent.ACTION_DOWN:
    if (!dontSendHistory) {
      for (int h=0; h < historySize; h++) {
        for (int p=0; p < pointerCount; p++) {
          touch=getNextFreeTouchEvent();
          touch.set(Type.DOWN,event.getHistoricalX(p,h),this.getHeight() - event.getHistoricalY(p,h),0,0);
          touch.setPointerId(event.getPointerId(p));
          touch.setTime(event.getHistoricalEventTime(h));
          touch.setPressure(event.getHistoricalPressure(p,h));
          processEvent(touch);
        }
      }
    }
  touch=getNextFreeTouchEvent();
touch.set(Type.DOWN,event.getX(0),this.getHeight() - event.getY(0),0,0);
touch.setPointerId(event.getPointerId(0));
touch.setTime(event.getEventTime());
touch.setPressure(event.getPressure(0));
processEvent(touch);
bWasHandled=true;
break;
case MotionEvent.ACTION_POINTER_1_UP:
case MotionEvent.ACTION_POINTER_2_UP:
case MotionEvent.ACTION_POINTER_3_UP:
case MotionEvent.ACTION_UP:
if (!dontSendHistory) {
for (int h=0; h < historySize; h++) {
for (int p=0; p < pointerCount; p++) {
touch=getNextFreeTouchEvent();
touch.set(Type.UP,event.getHistoricalX(p,h),this.getHeight() - event.getHistoricalY(p,h),0,0);
touch.setPointerId(event.getPointerId(p));
touch.setTime(event.getHistoricalEventTime(h));
touch.setPressure(event.getHistoricalPressure(p,h));
processEvent(touch);
}
}
}
touch=getNextFreeTouchEvent();
touch.set(Type.UP,event.getX(0),this.getHeight() - event.getY(0),0,0);
touch.setPointerId(event.getPointerId(0));
touch.setTime(event.getEventTime());
touch.setPressure(event.getPressure(0));
processEvent(touch);
bWasHandled=true;
break;
case MotionEvent.ACTION_MOVE:
if (!dontSendHistory) {
for (int h=0; h < historySize; h++) {
for (int p=0; p < pointerCount; p++) {
Vector2f lastPos=lastPositions.get(event.getPointerId(p));
if (lastPos == null) {
lastPos=new Vector2f(event.getHistoricalX(p,h),this.getHeight() - event.getHistoricalY(p,h));
lastPositions.put(event.getPointerId(p),lastPos);
}
touch=getNextFreeTouchEvent();
touch.set(Type.MOVE,event.getHistoricalX(p,h),this.getHeight() - event.getHistoricalY(p,h),event.getHistoricalX(p,h) - lastPos.x,this.getHeight() - event.getHistoricalY(p,h) - lastPos.y);
touch.setPointerId(event.getPointerId(p));
touch.setTime(event.getHistoricalEventTime(h));
touch.setPressure(event.getHistoricalPressure(p,h));
processEvent(touch);
lastPos.set(event.getHistoricalX(p,h),this.getHeight() - event.getHistoricalY(p,h));
}
}
}
for (int p=0; p < event.getPointerCount(); p++) {
Vector2f lastPos=lastPositions.get(event.getPointerId(p));
if (lastPos == null) {
lastPos=new Vector2f(event.getX(p),this.getHeight() - event.getY(p));
lastPositions.put(event.getPointerId(p),lastPos);
}
touch=getNextFreeTouchEvent();
touch.set(Type.MOVE,event.getX(p),this.getHeight() - event.getY(p),event.getX(p) - lastPos.x,this.getHeight() - event.getY(p) - lastPos.y);
touch.setPointerId(event.getPointerId(p));
touch.setTime(event.getEventTime());
touch.setPressure(event.getPressure(p));
processEvent(touch);
lastPos.set(event.getX(p),this.getHeight() - event.getY(p));
}
bWasHandled=true;
break;
case MotionEvent.ACTION_OUTSIDE:
break;
case MotionEvent.ACTION_CANCEL:
break;
}
this.detector.onTouchEvent(event);
this.scaledetector.onTouchEvent(event);
return bWasHandled;
}
