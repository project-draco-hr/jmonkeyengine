{
  boolean bWasHandled=false;
  TouchEvent touch;
  int action=event.getAction() & MotionEvent.ACTION_MASK;
  int pointerIndex=(event.getAction() & MotionEvent.ACTION_POINTER_INDEX_MASK) >> MotionEvent.ACTION_POINTER_INDEX_SHIFT;
  int pointerId=event.getPointerId(pointerIndex);
switch (action) {
case MotionEvent.ACTION_POINTER_DOWN:
case MotionEvent.ACTION_DOWN:
    touch=getNextFreeTouchEvent();
  touch.set(Type.DOWN,event.getX(pointerIndex),this.getHeight() - event.getY(pointerIndex),0,0);
touch.setPointerId(pointerId);
touch.setTime(event.getEventTime());
touch.setPressure(event.getPressure(pointerIndex));
processEvent(touch);
bWasHandled=true;
break;
case MotionEvent.ACTION_POINTER_UP:
case MotionEvent.ACTION_CANCEL:
case MotionEvent.ACTION_UP:
touch=getNextFreeTouchEvent();
touch.set(Type.UP,event.getX(pointerIndex),this.getHeight() - event.getY(pointerIndex),0,0);
touch.setPointerId(pointerId);
touch.setTime(event.getEventTime());
touch.setPressure(event.getPressure(pointerIndex));
processEvent(touch);
bWasHandled=true;
break;
case MotionEvent.ACTION_MOVE:
for (int p=0; p < event.getPointerCount(); p++) {
Vector2f lastPos=lastPositions.get(pointerIndex);
if (lastPos == null) {
lastPos=new Vector2f(event.getX(pointerIndex),this.getHeight() - event.getY(pointerIndex));
lastPositions.put(pointerId,lastPos);
}
touch=getNextFreeTouchEvent();
touch.set(Type.MOVE,event.getX(pointerIndex),this.getHeight() - event.getY(pointerIndex),event.getX(pointerIndex) - lastPos.x,this.getHeight() - event.getY(pointerIndex) - lastPos.y);
touch.setPointerId(pointerId);
touch.setTime(event.getEventTime());
touch.setPressure(event.getPressure(pointerIndex));
processEvent(touch);
lastPos.set(event.getX(pointerIndex),this.getHeight() - event.getY(pointerIndex));
}
bWasHandled=true;
break;
case MotionEvent.ACTION_OUTSIDE:
break;
}
this.detector.onTouchEvent(event);
this.scaledetector.onTouchEvent(event);
return bWasHandled;
}
