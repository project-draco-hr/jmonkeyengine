{
  Map<Material,List<Geometry>> matMap=new HashMap<Material,List<Geometry>>();
  maxVertCount=0;
  int nbGeoms=0;
  gatherGeomerties(matMap,this,needsFullRebatch);
  if (needsFullRebatch) {
    for (    Batch batch : batches.values()) {
      batch.geometry.removeFromParent();
    }
    batches.clear();
    batchesByGeom.clear();
  }
  for (  Map.Entry<Material,List<Geometry>> entry : matMap.entrySet()) {
    Mesh m=new Mesh();
    Material material=entry.getKey();
    List<Geometry> list=entry.getValue();
    nbGeoms+=list.size();
    if (!needsFullRebatch) {
      list.add(batches.get(material).geometry);
    }
    mergeGeometries(m,list);
    m.setDynamic();
    Batch batch=new Batch();
    batch.updateGeomList(list);
    batch.geometry=new Geometry(name + "-batch" + batches.size());
    batch.geometry.setMaterial(material);
    this.attachChild(batch.geometry);
    batch.geometry.setMesh(m);
    batch.geometry.getMesh().updateCounts();
    batch.geometry.getMesh().updateBound();
    batches.put(material,batch);
  }
  logger.log(Level.INFO,"Batched {0} geometries in {1} batches.",new Object[]{nbGeoms,batches.size()});
  tmpFloat=new float[maxVertCount * 3];
  tmpFloatN=new float[maxVertCount * 3];
  if (useTangents) {
    tmpFloatT=new float[maxVertCount * 4];
  }
}
