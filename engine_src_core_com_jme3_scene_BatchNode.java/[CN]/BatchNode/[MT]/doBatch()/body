{
  Map<Material,List<Geometry>> matMap=new HashMap<Material,List<Geometry>>();
  maxVertCount=0;
  gatherGeomerties(matMap,this);
  batches.clear();
  int nbGeoms=0;
  for (  Material material : matMap.keySet()) {
    Mesh m=new Mesh();
    List<Geometry> list=matMap.get(material);
    nbGeoms+=list.size();
    mergeGeometries(m,list);
    m.setDynamic();
    Batch batch=new Batch();
    batch.geometry=new Geometry(name + "-batch" + batches.size());
    batch.geometry.setMaterial(material);
    this.attachChild(batch.geometry);
    batch.geometry.setMesh(m);
    batch.geometry.getMesh().updateCounts();
    batch.geometry.getMesh().updateBound();
    batches.put(material,batch);
  }
  tmpFloat=new float[maxVertCount * 3];
  tmpFloatN=new float[maxVertCount * 3];
  if (useTangents) {
    tmpFloatT=new float[maxVertCount * 4];
  }
  logger.log(Level.INFO,"Batched {0} geometries in {1} batches.",new Object[]{nbGeoms,batches.size()});
}
