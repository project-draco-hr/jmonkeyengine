{
  if (latencyQueue != null)   sendDelayedMessages();
  if (npcs.size() == 0)   return;
  time+=tpf;
  if (time < updateRate) {
    return;
  }
 else {
    time=0;
  }
  SyncMessage msg=new SyncMessage();
  msg.setReliable(false);
  msg.heartbeat=heartbeat;
synchronized (npcs) {
    EntitySyncInfo[] infos=new EntitySyncInfo[npcs.size()];
    msg.infos=infos;
    for (int i=0; i < npcs.size(); i++) {
      SyncEntity entity=npcs.get(i);
      EntitySyncInfo info=generateSyncInfo(entity);
      entity.onLocalUpdate();
      infos[i]=info;
    }
  }
  if (latencyQueue != null) {
    long latencyTime=(long)(latency + (FastMath.nextRandomFloat() - 0.5f) * latency);
    long timeToSend=System.currentTimeMillis() + latencyTime;
    latencyQueue.put(timeToSend,msg);
  }
 else {
    for (    Client id : server.getConnectors()) {
      try {
        id.send(msg);
      }
 catch (      IOException ex) {
        ex.printStackTrace();
      }
    }
  }
  heartbeat++;
  if (heartbeat < 0) {
    heartbeat=0;
  }
}
