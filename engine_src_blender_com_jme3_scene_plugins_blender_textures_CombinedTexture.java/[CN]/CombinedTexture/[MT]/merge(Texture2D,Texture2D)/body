{
  if (target.getImage().getDepth() != source.getImage().getDepth()) {
    throw new IllegalArgumentException("Cannot merge images with different depths!");
  }
  Image sourceImage=source.getImage();
  Image targetImage=target.getImage();
  PixelInputOutput sourceIO=PixelIOFactory.getPixelIO(sourceImage.getFormat());
  PixelInputOutput targetIO=PixelIOFactory.getPixelIO(targetImage.getFormat());
  TexturePixel sourcePixel=new TexturePixel();
  TexturePixel targetPixel=new TexturePixel();
  int depth=target.getImage().getDepth() == 0 ? 1 : target.getImage().getDepth();
  for (int layerIndex=0; layerIndex < depth; ++layerIndex) {
    for (int x=0; x < sourceImage.getWidth(); ++x) {
      for (int y=0; y < sourceImage.getHeight(); ++y) {
        sourceIO.read(sourceImage,layerIndex,sourcePixel,x,y);
        targetIO.read(targetImage,layerIndex,targetPixel,x,y);
        targetPixel.merge(sourcePixel);
        targetIO.write(targetImage,layerIndex,targetPixel,x,y);
      }
    }
  }
}
