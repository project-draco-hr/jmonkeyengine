{
switch (image.getFormat()) {
case RGBA8:
    buf.position(position * 4);
  store.set(byte2float(buf.get()),byte2float(buf.get()),byte2float(buf.get()),byte2float(buf.get()));
return calculateHeight(store.r,store.g,store.b);
case ABGR8:
buf.position(position * 4);
float a=byte2float(buf.get());
float b=byte2float(buf.get());
float g=byte2float(buf.get());
float r=byte2float(buf.get());
store.set(r,g,b,a);
return calculateHeight(store.r,store.g,store.b);
case RGB8:
buf.position(position * 3);
store.set(byte2float(buf.get()),byte2float(buf.get()),byte2float(buf.get()),1);
return calculateHeight(store.r,store.g,store.b);
case Luminance8:
buf.position(position);
return byte2float(buf.get()) * 255 * heightScale;
case Luminance16:
ShortBuffer sbuf=buf.asShortBuffer();
sbuf.position(position);
return (sbuf.get() & 0xFFFF) / 65535f * 255f * heightScale;
default :
throw new UnsupportedOperationException("Image format: " + image.getFormat());
}
}
