{
  aliasCount=1;
  idCount=1;
  classes.clear();
  contentTable.clear();
  locationTable.clear();
  contentKeys.clear();
  int id=processBinarySavable(object);
  int ttbytes=0;
  int classNum=classes.keySet().size();
  int aliasWidth=((int)FastMath.log(classNum,256) + 1);
  os.write(ByteUtils.convertToBytes(classNum));
  for (  String key : classes.keySet()) {
    BinaryClassObject bco=classes.get(key);
    byte[] aliasBytes=fixClassAlias(bco.alias,aliasWidth);
    os.write(aliasBytes);
    ttbytes+=aliasWidth;
    byte[] classBytes=key.getBytes();
    os.write(ByteUtils.convertToBytes(classBytes.length));
    os.write(classBytes);
    ttbytes+=4 + classBytes.length;
    os.write(ByteUtils.convertToBytes(bco.nameFields.size()));
    for (    String fieldName : bco.nameFields.keySet()) {
      BinaryClassField bcf=bco.nameFields.get(fieldName);
      os.write(bcf.alias);
      os.write(bcf.type);
      byte[] fNameBytes=fieldName.getBytes();
      os.write(ByteUtils.convertToBytes(fNameBytes.length));
      os.write(fNameBytes);
      ttbytes+=2 + 4 + fNameBytes.length;
    }
  }
  ByteArrayOutputStream out=new ByteArrayOutputStream();
  int location=0;
  HashMap<String,ArrayList<BinaryIdContentPair>> alreadySaved=new HashMap<String,ArrayList<BinaryIdContentPair>>(contentTable.size());
  for (  Savable savable : contentKeys) {
    String savableName=savable.getClass().getName();
    BinaryIdContentPair pair=contentTable.get(savable);
    ArrayList<BinaryIdContentPair> bucket=alreadySaved.get(savableName + getChunk(pair));
    int prevLoc=findPrevMatch(pair,bucket);
    if (prevLoc != -1) {
      locationTable.put(pair.getId(),prevLoc);
      continue;
    }
    locationTable.put(pair.getId(),location);
    if (bucket == null) {
      bucket=new ArrayList<BinaryIdContentPair>();
      alreadySaved.put(savableName + getChunk(pair),bucket);
    }
    bucket.add(pair);
    byte[] aliasBytes=fixClassAlias(classes.get(savableName).alias,aliasWidth);
    out.write(aliasBytes);
    location+=aliasWidth;
    BinaryOutputCapsule cap=contentTable.get(savable).getContent();
    out.write(ByteUtils.convertToBytes(cap.bytes.length));
    location+=4;
    out.write(cap.bytes);
    location+=cap.bytes.length;
  }
  int locNum=locationTable.keySet().size();
  os.write(ByteUtils.convertToBytes(locNum));
  int locbytes=0;
  for (  Integer key : locationTable.keySet()) {
    os.write(ByteUtils.convertToBytes(key));
    os.write(ByteUtils.convertToBytes(locationTable.get(key)));
    locbytes+=8;
  }
  os.write(ByteUtils.convertToBytes(1));
  os.write(ByteUtils.convertToBytes(id));
  out.writeTo(os);
  out=null;
  os=null;
  if (debug) {
    logger.info("Stats:");
    logger.info("classes: " + classNum);
    logger.info("class table: " + ttbytes + " bytes");
    logger.info("objects: " + locNum);
    logger.info("location table: " + locbytes + " bytes");
    logger.info("data: " + location + " bytes");
  }
  return true;
}
