{
  List<Geometry> geometries=new ArrayList<Geometry>();
  gatherGeoms(spat,geometries);
  TextureAtlas atlas=new TextureAtlas(atlasSize,atlasSize);
  for (  Geometry geometry : geometries) {
    Texture diffuse=getMaterialTexture(geometry,"DiffuseMap");
    Texture normal=getMaterialTexture(geometry,"NormalMap");
    Texture specular=getMaterialTexture(geometry,"SpecularMap");
    if (diffuse == null) {
      diffuse=getMaterialTexture(geometry,"ColorMap");
    }
    if (diffuse != null && diffuse.getKey() != null) {
      String keyName=diffuse.getKey().getName();
      if (!atlas.addTexture(diffuse,"DiffuseMap")) {
        logger.log(Level.WARNING,"Adding diffuse texture {0} to atlas failed, atlas full?",keyName);
      }
      if (normal != null && normal.getKey() != null) {
        atlas.addTexture(diffuse,"NormalMap",keyName);
      }
      if (specular != null && specular.getKey() != null) {
        atlas.addTexture(specular,"SpecularMap",keyName);
      }
    }
  }
  Geometry geom=new Geometry();
  Mesh mesh=new Mesh();
  mergeGeometries(geometries,mesh,atlas);
  TangentBinormalGenerator.generate(mesh);
  mesh.updateCounts();
  mesh.updateBound();
  geom.setMesh(mesh);
  Material mat=new Material(mgr,"Common/MatDefs/Light/Lighting.j3md");
  Texture diffuseMap=atlas.getAtlasTexture("DiffuseMap");
  Texture normalMap=atlas.getAtlasTexture("NormalMap");
  Texture specularMap=atlas.getAtlasTexture("SpecularMap");
  if (diffuseMap != null) {
    mat.setTexture("DiffuseMap",diffuseMap);
  }
  if (normalMap != null) {
    mat.setTexture("NormalMap",normalMap);
  }
  if (specularMap != null) {
    mat.setTexture("SpecularMap",specularMap);
  }
  mat.setFloat("Shininess",16.0f);
  geom.setMaterial(mat);
  return geom;
}
