{
  final ProjectAssetManager manager=selectedNode.getLookup().lookup(ProjectAssetManager.class);
  Terrain terrain=new TerrainQuad("terrain-" + sceneName,patchSize,totalSize,heightmapData);
  com.jme3.material.Material mat=new com.jme3.material.Material(manager,"Common/MatDefs/Terrain/TerrainLighting.j3md");
  String assetFolder="";
  if (manager != null && manager instanceof ProjectAssetManager)   assetFolder=((ProjectAssetManager)manager).getAssetFolderName();
  for (int i=0; i < TerrainEditorController.NUM_ALPHA_TEXTURES; i++) {
    BufferedImage alphaBlend=new BufferedImage(alphaTextureSize,alphaTextureSize,BufferedImage.TYPE_INT_ARGB);
    if (i == 0) {
      for (int h=0; h < alphaTextureSize; h++)       for (int w=0; w < alphaTextureSize; w++)       alphaBlend.setRGB(w,h,0x00FF0000);
    }
    File textureFolder=new File(assetFolder + "/Textures/");
    if (!textureFolder.exists())     textureFolder.mkdir();
    File alphaFolder=new File(assetFolder + "/Textures/terrain-alpha/");
    if (!alphaFolder.exists())     alphaFolder.mkdir();
    String alphaBlendFileName="/Textures/terrain-alpha/" + sceneName + "-"+ ((Node)terrain).getName()+ "-alphablend"+ i+ ".png";
    File alphaImageFile=new File(assetFolder + alphaBlendFileName);
    ImageIO.write(alphaBlend,"png",alphaImageFile);
    Texture tex=manager.loadAsset(new TextureKey(alphaBlendFileName,false));
    if (i == 0)     mat.setTexture("AlphaMap",tex);
 else     if (i == 1)     mat.setTexture("AlphaMap_1",tex);
 else     if (i == 2)     mat.setTexture("AlphaMap_2",tex);
  }
  Texture defaultTexture=manager.loadTexture(TerrainEditorController.DEFAULT_TERRAIN_TEXTURE);
  String dirtTextureName="/Textures/dirt.jpg";
  File dirtTextureFile=new File(assetFolder + dirtTextureName);
  if (!dirtTextureFile.exists()) {
    BufferedImage bi=ImageToAwt.convert(defaultTexture.getImage(),false,true,0);
    ImageIO.write(bi,"jpg",dirtTextureFile);
  }
  Texture dirtTexture=manager.loadTexture(dirtTextureName);
  dirtTexture.setWrap(WrapMode.Repeat);
  mat.setTexture("DiffuseMap",dirtTexture);
  mat.setFloat("DiffuseMap_0_scale",TerrainEditorController.DEFAULT_TEXTURE_SCALE);
  mat.setBoolean("WardIso",true);
  mat.setFloat("Shininess",0.01f);
  ((Node)terrain).setMaterial(mat);
  ((Node)terrain).setModelBound(new BoundingBox());
  ((Node)terrain).updateModelBound();
  ((Node)terrain).setLocalTranslation(0,0,0);
  ((Node)terrain).setLocalScale(1f,1f,1f);
  TerrainLodControl control=new TerrainLodControl(terrain,SceneApplication.getApplication().getCamera());
  control.setLodCalculator(new DistanceLodCalculator(patchSize,2.7f));
  ((Node)terrain).addControl(control);
  parent.attachChild((Node)terrain);
  return (Spatial)terrain;
}
