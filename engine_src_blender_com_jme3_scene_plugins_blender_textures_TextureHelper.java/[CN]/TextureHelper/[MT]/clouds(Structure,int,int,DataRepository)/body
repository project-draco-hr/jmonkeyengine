{
  float wDelta=1.0f / width, hDelta=1.0f / height;
  float[] texvec=new float[]{0,0,0};
  TexResult texres=new TexResult();
  float noisesize=((Number)tex.getFieldValue("noisesize")).floatValue();
  int noiseDepth=((Number)tex.getFieldValue("noisedepth")).intValue();
  int noiseBasis=((Number)tex.getFieldValue("noisebasis")).intValue();
  int noiseType=((Number)tex.getFieldValue("noisetype")).intValue();
  float contrast=((Number)tex.getFieldValue("contrast")).floatValue();
  float bright=((Number)tex.getFieldValue("bright")).floatValue();
  boolean isHard=noiseType != NoiseGenerator.TEX_NOISESOFT;
  int sType=((Number)tex.getFieldValue("stype")).intValue();
  int halfW=width, halfH=height;
  width<<=1;
  height<<=1;
  ColorBand colorBand=this.readColorband(tex,dataRepository);
  Format format=sType == NoiseGenerator.TEX_COLOR || colorBand != null ? Format.RGB8 : Format.Luminance8;
  int bytesPerPixel=sType == NoiseGenerator.TEX_COLOR || colorBand != null ? 3 : 1;
  ByteBuffer data=BufferUtils.createByteBuffer(width * height * bytesPerPixel);
  for (int i=-halfW; i < halfW; ++i) {
    texvec[0]=wDelta * i;
    for (int j=-halfH; j < halfH; ++j) {
      texvec[1]=hDelta * j;
      texres.tin=noiseHelper.bliGTurbulence(noisesize,texvec[0],texvec[1],texvec[2],noiseDepth,isHard,noiseBasis);
      if (colorBand != null) {
        noiseHelper.doColorband(colorBand,texres,dataRepository);
        if (texres.nor != null) {
          float nabla=((Number)tex.getFieldValue("nabla")).floatValue();
          texres.nor[0]=noiseHelper.bliGTurbulence(noisesize,texvec[0] + nabla,texvec[1],texvec[2],noiseDepth,isHard,noiseBasis);
          texres.nor[1]=noiseHelper.bliGTurbulence(noisesize,texvec[0],texvec[1] + nabla,texvec[2],noiseDepth,isHard,noiseBasis);
          texres.nor[2]=noiseHelper.bliGTurbulence(noisesize,texvec[0],texvec[1],texvec[2] + nabla,noiseDepth,isHard,noiseBasis);
          noiseHelper.texNormalDerivate(colorBand,texres,dataRepository);
        }
        noiseHelper.brightnesAndContrastRGB(tex,texres);
        data.put((byte)(texres.tr * 255.0f));
        data.put((byte)(texres.tg * 255.0f));
        data.put((byte)(texres.tb * 255.0f));
      }
 else       if (sType == NoiseGenerator.TEX_COLOR) {
        texres.tr=texres.tin;
        texres.tg=noiseHelper.bliGTurbulence(noisesize,texvec[1],texvec[0],texvec[2],noiseDepth,isHard,noiseBasis);
        texres.tb=noiseHelper.bliGTurbulence(noisesize,texvec[1],texvec[2],texvec[0],noiseDepth,isHard,noiseBasis);
        noiseHelper.brightnesAndContrastRGB(tex,texres);
        data.put((byte)(texres.tr * 255.0f));
        data.put((byte)(texres.tg * 255.0f));
        data.put((byte)(texres.tb * 255.0f));
      }
 else {
        noiseHelper.brightnesAndContrast(texres,contrast,bright);
        data.put((byte)(texres.tin * 255));
      }
    }
  }
  return new Texture2D(new Image(format,width,height,data));
}
