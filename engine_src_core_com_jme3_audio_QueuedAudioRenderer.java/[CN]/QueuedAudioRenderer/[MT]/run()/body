{
  wrapped.initialize();
  long updateRateNanos=(long)(UPDATE_RATE * 1000000000);
  mainloop:   while (true) {
    long startTime=System.nanoTime();
synchronized (thread) {
      while (commandQueue.size() > 0) {
        Command cmd=commandQueue.remove();
        if (cmd.type == CmdType.Cleanup)         break mainloop;
        executeCommand(cmd);
      }
    }
    wrapped.update(UPDATE_RATE);
    long endTime=System.nanoTime();
    long diffTime=endTime - startTime;
    if (diffTime < updateRateNanos) {
      long desiredEndTime=startTime + updateRateNanos;
      while (System.nanoTime() < desiredEndTime) {
        try {
          Thread.sleep(1);
        }
 catch (        InterruptedException ex) {
        }
      }
    }
  }
  commandQueue.clear();
  wrapped.cleanup();
}
